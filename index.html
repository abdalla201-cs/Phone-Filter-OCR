<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone Number Processor Pro</title>
    <!-- Site Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìû</text></svg>">
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        /* CSS Variables for Dark Theme */
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --bg-input: #2a2a2a;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --accent-color: #0d6efd;
            --accent-hover: #0b5ed7;
            --border-color: #3a3a3a;
            --success-color: #198754;
            --error-color: #dc3545;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 24px;
            background-color: var(--bg-dark);
            color: var(--text-secondary);
            box-sizing: border-box;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header { text-align: center; margin-bottom: 10px; }
        header h1 { color: var(--text-primary); margin: 0; font-size: 2rem; display: flex; align-items: center; justify-content: center; gap: 12px; }
        header h1::before { content: 'üìû'; font-size: 1.8rem; }
        header p { margin-top: 4px; opacity: 0.7; }

        .top-panel { display: grid; grid-template-columns: 1fr 1fr 280px; gap: 20px; }
        @media (max-width: 1024px) { .top-panel { grid-template-columns: 1fr; } }

        .card { background-color: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); box-shadow: var(--shadow); display: flex; flex-direction: column; }
        .card h3 { color: var(--accent-color); font-size: 1.15rem; border-bottom: 1px solid var(--border-color); padding-bottom: 12px; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px; }

        .stats-grid { display: flex; flex-direction: column; gap: 12px; }
        .stat-item { display: flex; justify-content: space-between; background-color: var(--bg-input); padding: 8px 12px; border-radius: 6px; }
        .stat-item .value { font-weight: bold; color: var(--text-primary); }

        #drop-zone { border: 2px dashed var(--border-color); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; flex-grow: 1; display: flex; align-items: center; justify-content: center; min-height: 120px; }
        #drop-zone.drag-over { background-color: var(--bg-input); border-color: var(--accent-color); }
        #file-input { display: none; }

        .input-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }

        #text-input { width: 100%; min-height: 180px; background-color: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); padding: 12px; resize: vertical; box-sizing: border-box; font-family: monospace; }

        button { padding: 12px 16px; border-radius: 8px; border: none; background-color: var(--accent-color); color: #fff; font-weight: bold; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; }
        button:hover { background-color: var(--accent-hover); transform: translateY(-1px); }
        button.secondary { background-color: var(--bg-input); border: 1px solid var(--border-color); margin-top: 0; }
        button.secondary:hover { background-color: var(--border-color); }
        #clear-session-btn { background-color: var(--error-color); width: 100%; margin-top: 20px; }

        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-top: 10px; }
        .result-content { font-family: 'Courier New', Courier, monospace; font-size: 0.95rem; background-color: var(--bg-input); padding: 15px; border-radius: 8px; min-height: 250px; max-height: 600px; overflow-y: auto; }
        
        .copy-btn { float: right; padding: 4px 8px; font-size: 0.75rem; background-color: var(--border-color); margin-top: -5px; }

        .contact-block { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .contact-name { font-weight: bold; color: #fff; font-size: 1.1rem; margin-bottom: 5px; text-transform: uppercase; }
        .contact-detail { color: var(--text-secondary); opacity: 0.8; font-size: 0.85rem; margin-left: 5px; }
        .contact-number { color: var(--accent-color); font-weight: 500; margin-top: 2px; }

        #notification { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 12px 24px; border-radius: 8px; transition: 0.5s; z-index: 1000; }
        #notification.show { top: 20px; }
        
        .progress-bar-container { width: 100%; background-color: var(--bg-input); border-radius: 8px; height: 8px; margin-top: 15px; display: none; overflow: hidden; }
        #progress-bar { width: 0%; height: 100%; background-color: var(--accent-color); transition: width 0.3s ease; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Phone Number Processor Pro</h1>
            <p>Smart extraction with robust name recognition and deduplication.</p>
        </header>

        <section class="top-panel">
            <div class="card">
                <h3>üñºÔ∏è OCR Image Upload</h3>
                <div id="drop-zone">
                    <p>Drag images here or click to browse</p>
                    <input type="file" id="file-input" multiple accept="image/*">
                </div>
                <div class="input-buttons">
                    <button id="browse-btn" class="secondary">üìÅ Choose Files</button>
                    <button id="paste-btn" class="secondary">üìã Paste Image</button>
                </div>
                <div class="progress-bar-container" id="progress-container">
                     <div id="progress-bar"></div>
                </div>
            </div>

            <div class="card">
                <h3>‚úçÔ∏è Text Input</h3>
                <textarea id="text-input" placeholder="Paste data containing names, addresses, emails..."></textarea>
                <button id="process-text-btn">‚ö° Filter & Extract Data</button>
            </div>

            <div class="card">
                 <h3>üìä Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item"><span>Total Instances:</span> <span id="stats-total" class="value">0</span></div>
                    <div class="stat-item"><span>Unique Numbers:</span> <span id="stats-unique" class="value">0</span></div>
                </div>
                <button id="clear-session-btn">üóëÔ∏è Clear Session</button>
            </div>
        </section>
        
        <section class="results-grid">
            <div class="card">
                <h3>üìã Results (by Name) <button class="copy-btn" data-target="cleaned-numbers-list">Copy</button></h3>
                <div class="result-content" id="cleaned-numbers-list"></div>
            </div>
            <div class="card">
                <h3>üá∫üá∏ American Format <button class="copy-btn" data-target="american-format-list">Copy</button></h3>
                <div class="result-content" id="american-format-list"></div>
            </div>
            <div class="card">
                <h3>üîÑ Duplicates Found <button class="copy-btn" data-target="duplicate-numbers-list">Copy</button></h3>
                <div class="result-content" id="duplicate-numbers-list"></div>
            </div>
        </section>
    </div>

    <div id="notification"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const textInput = document.getElementById('text-input');
            const processTextBtn = document.getElementById('process-text-btn');
            const clearSessionBtn = document.getElementById('clear-session-btn');
            const fileInput = document.getElementById('file-input');
            const browseBtn = document.getElementById('browse-btn');
            const pasteBtn = document.getElementById('paste-btn');
            const dropZone = document.getElementById('drop-zone');
            const progressBar = document.getElementById('progress-bar');
            const progressContainer = document.getElementById('progress-container');
            const notification = document.getElementById('notification');

            let contacts = []; 
            let globalInstances = []; 
            let globalAssignedSet = new Set(); 

            const phoneRegex = /\b(?:\+?1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g;

            const cleanPhoneNumber = (raw) => {
                let cleaned = raw.replace(/[^\d]/g, '');
                if (cleaned.length === 11 && cleaned.startsWith('1')) cleaned = cleaned.substring(1);
                return cleaned.length === 10 ? cleaned : null;
            };

            const formatCleaned = (num) => `(${num.substring(0, 3)}) ${num.substring(3, 6)}-${num.substring(6, 10)}`;
            const formatAmerican = (num) => `+1 ${formatCleaned(num)}`;

            const cleanName = (str) => {
                return str.replace(/\s*\(\d+\)\s*/g, ' ')
                          .replace(/deceased/gi, '')
                          .replace(/email address:?/gi, '')
                          .replace(/phone #\(s\):?/gi, '')
                          .replace(/\b(est|edt|cst|cdt|pst|pdt|mst|mdt)\b/gi, '')
                          .trim().replace(/\s{2,}/g, ' ');
            };

            const isTechnicalGarbage = (str) => {
                const lower = str.toLowerCase();
                // Expanded list to catch "EMAIL ADDRESS:" and "PHONE #(S)"
                const keys = ['sources', 'phone type', 'household listing', 'bank account', 'motor vehicle', 'warranty', 'experian', 'transunion', 'equifax', 'historic', 'current', 'null', 'associated', 'relatives', 'alias', 'email address', 'phone #', 'records found'];
                return keys.some(k => lower.includes(k));
            };

            const isDetailLine = (line) => {
                if (line.includes('@')) return true;
                const hasDigits = /\d/.test(line);
                const addrKeywords = /\b(st|ave|rd|blvd|dr|ln|ct|pl|hls|hl|suite|apt|unit|floor|fl|ny|nj|ca|tx|fl)\b/i;
                return hasDigits && addrKeywords.test(line);
            };

            const preprocessImage = async (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const scale = 3;
                            canvas.width = img.width * scale;
                            canvas.height = img.height * scale;
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const data = imageData.data;
                            for (let i = 0; i < data.length; i += 4) {
                                const grey = 0.2126 * data[i] + 0.7152 * data[i + 1] + 0.0722 * data[i + 2];
                                const val = grey < 190 ? 0 : 255;
                                data[i] = data[i+1] = data[i+2] = val;
                            }
                            ctx.putImageData(imageData, 0, 0);
                            resolve(canvas.toDataURL('image/png'));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            const parseData = (text) => {
                const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                let currentContact = null;

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const rawPhones = line.match(phoneRegex) || [];
                    const emails = line.match(/[\w.-]+@[\w.-]+\.[a-zA-Z]{2,}/g) || [];

                    let isName = false;
                    const cleanLine = cleanName(line);

                    // Name Detection Logic
                    if (rawPhones.length === 0 && emails.length === 0) {
                        if (!isTechnicalGarbage(cleanLine) && cleanLine.length > 3) {
                            // Signals that the previous line was likely a name
                            if (i + 1 < lines.length) {
                                const next = lines[i+1].toLowerCase();
                                const hasPhoneSignal = next.includes('phone') || next.includes('#') || next.match(phoneRegex);
                                const hasEmailSignal = next.includes('@') || next.includes('email address');
                                const hasTechSignal = next.includes('sources') || next.includes('type');
                                if (hasPhoneSignal || hasEmailSignal || hasTechSignal) isName = true;
                            }
                            // ALL CAPS check as secondary confirmation
                            if (!isName && /^[A-Z,\.\s\-]+$/.test(cleanLine) && cleanLine.split(' ').length <= 6) isName = true;
                        }
                    }

                    if (isName) {
                        currentContact = { name: cleanLine, details: [], numbers: [] };
                        contacts.push(currentContact);
                        continue;
                    }

                    let target = currentContact || null;
                    if (!target && (rawPhones.length > 0 || emails.length > 0)) {
                        target = { name: "Extracted Data", details: [], numbers: [] };
                        contacts.push(target);
                        currentContact = target;
                    }

                    if (target) {
                        rawPhones.forEach(p => {
                            const cleaned = cleanPhoneNumber(p);
                            if (cleaned) {
                                globalInstances.push(cleaned);
                                if (!globalAssignedSet.has(cleaned)) {
                                    target.numbers.push(cleaned);
                                    globalAssignedSet.add(cleaned);
                                }
                            }
                        });
                        emails.forEach(e => { if (!target.details.includes(e)) target.details.push(e); });
                        
                        if (rawPhones.length === 0 && emails.length === 0 && !isName) {
                             if (isDetailLine(line)) {
                                 if (!target.details.includes(line)) target.details.push(line);
                             }
                        }
                    }
                }
                contacts = contacts.filter(c => c.numbers.length > 0 || c.details.length > 0);
                updateUI();
            };

            const updateUI = () => {
                const cleanedList = document.getElementById('cleaned-numbers-list');
                const americanList = document.getElementById('american-format-list');
                const duplicateList = document.getElementById('duplicate-numbers-list');
                cleanedList.innerHTML = ''; americanList.innerHTML = ''; duplicateList.innerHTML = '';
                
                const dupCounts = {};
                globalInstances.forEach(n => dupCounts[n] = (dupCounts[n] || 0) + 1);

                contacts.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'contact-block';
                    div.innerHTML = `<div class="contact-name">${c.name}</div>`;
                    c.details.forEach(d => div.innerHTML += `<div class="contact-detail">${d}</div>`);
                    c.numbers.forEach(n => div.innerHTML += `<div class="contact-number">${formatCleaned(n)}</div>`);
                    cleanedList.appendChild(div);
                });

                Array.from(globalAssignedSet).forEach(n => {
                    const item = document.createElement('div');
                    item.textContent = formatAmerican(n);
                    americanList.appendChild(item);
                });

                Object.entries(dupCounts).forEach(([n, count]) => {
                    if (count > 1) {
                        const item = document.createElement('div');
                        item.textContent = `${formatCleaned(n)} (${count} times)`;
                        duplicateList.appendChild(item);
                    }
                });

                document.getElementById('stats-total').textContent = globalInstances.length;
                document.getElementById('stats-unique').textContent = globalAssignedSet.size;
            };

            const showNotification = (msg) => {
                notification.textContent = msg;
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 3000);
            };

            const handleFiles = async (files) => {
                if (!files.length) return;
                progressContainer.style.display = 'block';
                for (const f of files) {
                    try {
                        const processedDataUrl = await preprocessImage(f);
                        const { data: { text } } = await Tesseract.recognize(processedDataUrl, 'eng', {
                            logger: m => { if (m.status === 'recognizing text') progressBar.style.width = (m.progress * 100) + '%'; }
                        });
                        parseData(text);
                    } catch (e) { showNotification("OCR Error on " + f.name); }
                }
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
                showNotification("Image data processed with high precision.");
            };

            processTextBtn.addEventListener('click', () => {
                const text = textInput.value.trim();
                if (!text) return showNotification("Input is empty");
                parseData(text);
                textInput.value = ''; 
            });

            clearSessionBtn.addEventListener('click', () => {
                contacts = []; globalInstances = []; globalAssignedSet.clear(); textInput.value = ''; updateUI();
                showNotification("Session cleared successfully");
            });

            browseBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
            pasteBtn.addEventListener('click', () => showNotification("Press Ctrl+V to paste an image directly"));

            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-over'); });
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
            dropZone.addEventListener('click', () => fileInput.click());

            document.addEventListener('paste', (e) => {
                if (document.activeElement.tagName === 'TEXTAREA') return;
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                const files = [];
                for (const item of items) { if (item.type.indexOf("image") !== -1) files.push(item.getAsFile()); }
                if (files.length > 0) handleFiles(files);
            });

            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const target = document.getElementById(btn.dataset.target);
                    const range = document.createRange();
                    range.selectNode(target);
                    window.getSelection().removeAllRanges();
                    window.getSelection().addRange(range);
                    document.execCommand('copy');
                    window.getSelection().removeAllRanges();
                    showNotification("Copied to clipboard!");
                });
            });
        });
    </script>
</body>
</html>
